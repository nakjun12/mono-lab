name: Test Stateful Reviewer Workflow

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [main]

jobs:
  test_job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

  # ì„±ê³µ/ì‹¤íŒ¨ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ì•„ë˜ ë‘ ì¡ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ì—¬ ì‚¬ìš©í•˜ì„¸ìš”.
  success_job:
    name: This job will succeed
    runs-on: ubuntu-latest
    steps:
      - name: ì„±ê³µí•˜ëŠ” ë‹¨ê³„
        run: echo "This job always succeeds."

  # failure_job:
  #   name: This job will fail
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: ì‹¤íŒ¨í•˜ëŠ” ë‹¨ê³„
  #       run: |
  #         echo "This job is designed to fail."
  #         exit 1

  notify-on-completion:
    name: Notify Slack on Job Completion
    # ì‹¤íŒ¨ë¥¼ í…ŒìŠ¤íŠ¸í•˜ë ¤ë©´ 'success_job'ì„ 'failure_job'ìœ¼ë¡œ ë°”ê¾¸ì„¸ìš”.
    needs: [test_job, success_job]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - name: Check gh CLI Version
        run: gh --version


      - name: Run Stateful Notification Logic
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          NEEDS_JSON: ${{ toJson(needs) }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          PR_LABELS: ${{ toJSON(github.event.pull_request.labels.*.name) }}
        run: |
          # ================================================================
          # ğŸ“ ì‚¬ì „ ì¤€ë¹„ ë° ë””ë²„ê¹… ë¡œê·¸
          # ================================================================
          echo "=== ğŸš¦ ì›Œí¬í”Œë¡œìš° ì‹œì‘: ìƒíƒœ í™•ì¸ ë° ì•Œë¦¼ ì²˜ë¦¬ ==="
          source .github/script/team_review_helpers.sh
          TEAM_MEMBERS=$(cat .github/config/team_members.json)

          PR_URL="${{ github.event.pull_request.html_url }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          ADDITIONS="${{ github.event.pull_request.additions }}"
          DELETIONS="${{ github.event.pull_request.deletions }}"
          CHANGED_FILES="${{ github.event.pull_request.changed_files }}"

          # íŒ€ ë©¤ë²„ í™•ì¸
          if ! check_author "$TEAM_MEMBERS" "$PR_AUTHOR"; then
              echo "ì‘ì„±ìê°€ íŒ€ ë©¤ë²„ê°€ ì•„ë‹ˆë¯€ë¡œ ì•Œë¦¼ì„ ê±´ë„ˆëœë‹ˆë‹¤."
              exit 0
          fi

          AUTHOR_NAME=$(get_review_member_info "$TEAM_MEMBERS" "$PR_AUTHOR" "name")
          AUTHOR_MENTION="<@$(get_review_member_info "$TEAM_MEMBERS" "$PR_AUTHOR" "slack_id")>"

          # íŒŒì¼ ë³€ê²½ ì •ë³´ ë¬¸ìì—´ ìƒì„±
          if [ -n "$CHANGED_FILES" ] && [ "$CHANGED_FILES" != "0" ]; then
            FILES_INFO=" (${CHANGED_FILES} files)"
          else
            FILES_INFO=""
          fi

          # ================================================================
          # ğŸ” í˜„ì¬ ìƒíƒœ ë° ì´ì „ ìƒíƒœ ë¶„ì„
          # ================================================================

          # í˜„ì¬ ë¹Œë“œ ìƒíƒœ ê²°ì •
          CURRENT_BUILD_STATUS="success"
          if echo "$NEEDS_JSON" | jq -e '.[] | select(.result == "failure" or .result == "cancelled")' > /dev/null; then
            CURRENT_BUILD_STATUS="failure"
          fi
          echo "âœ… í˜„ì¬ ë¹Œë“œ ìƒíƒœ: $CURRENT_BUILD_STATUS"

          # ì´ì „ ìƒíƒœ í™•ì¸ (ë¼ë²¨ ê¸°ë°˜)
          HAS_BUILD_FAILED_LABEL=$(echo "$PR_LABELS" | jq -e 'any(. == "build-failed")')
          HAS_REVIEW_REQUESTED_LABEL=$(echo "$PR_LABELS" | jq -e 'any(. == "review-requested")')

          # ================================================================
          # ğŸ“‹ ìƒíƒœë³„ ì²˜ë¦¬ ë¡œì§ ë° ë©”ì‹œì§€ ì¤€ë¹„
          # ================================================================

          SLACK_ICON=""
          SLACK_MESSAGE=""
          REVIEWER_MENTIONS=""
          NEEDS_REVIEWER_ASSIGNMENT=false

          case "$CURRENT_BUILD_STATUS" in
            "failure")
              echo "ğŸš« ë¹Œë“œ ì‹¤íŒ¨ ì²˜ë¦¬"
              SLACK_ICON=":x:"
              SLACK_MESSAGE="ë¹Œë“œ ì‹¤íŒ¨"

              # ë¼ë²¨ ê´€ë¦¬
              gh pr edit $PR_NUMBER --add-label "build-failed"
              if $HAS_REVIEW_REQUESTED_LABEL; then
                echo "ğŸ·ï¸ 'review-requested' ë¼ë²¨ ì œê±°"
                gh pr edit $PR_NUMBER --remove-label "review-requested"
              fi

              GITHUB_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              SLACK_MESSAGE="$SLACK_MESSAGE
              *Github Action:* $GITHUB_URL"
              ;;

            "success")
              echo "âœ… ë¹Œë“œ ì„±ê³µ ì²˜ë¦¬"
              SLACK_ICON=":white_check_mark:"

              # build-failed ë¼ë²¨ì´ ìˆìœ¼ë©´ ì œê±°
              if $HAS_BUILD_FAILED_LABEL; then
                echo "ğŸ·ï¸ 'build-failed' ë¼ë²¨ ì œê±°"
                gh pr edit $PR_NUMBER --remove-label "build-failed"
              fi

              # ë¦¬ë·°ì–´ í• ë‹¹ í•„ìš”ì„± íŒë‹¨
              if ! $HAS_REVIEW_REQUESTED_LABEL; then
                echo "ğŸ¤ ìµœì´ˆ ì„±ê³µ - ë¦¬ë·°ì–´ í• ë‹¹ í•„ìš”"
                NEEDS_REVIEWER_ASSIGNMENT=true
                SLACK_MESSAGE="ë¦¬ë·° ìš”ì²­"
              else
                echo "ğŸ“ ìˆ˜ì • ì™„ë£Œ - ë¦¬ë·°ì–´ì—ê²Œ ì•Œë¦¼ë§Œ ì „ì†¡"
                SLACK_MESSAGE="ì½”ë“œ ìˆ˜ì • ì™„ë£Œ"

                # ê¸°ì¡´ ë¦¬ë·°ì–´ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ë©˜ì…˜ìš©)
                EXISTING_REVIEWERS=$(gh pr view $PR_NUMBER --json reviewRequests --jq '.reviewRequests[].login' | tr '\n' ',' | sed 's/,$//')
                if [ -n "$EXISTING_REVIEWERS" ]; then
                  IFS=',' read -r -a reviewer_array <<< "$EXISTING_REVIEWERS"
                  for reviewer in "${reviewer_array[@]}"; do
                    if [ -n "$reviewer" ]; then
                      slack_id=$(get_review_member_info "$TEAM_MEMBERS" "$reviewer" "slack_id")
                      REVIEWER_MENTIONS+="<@$slack_id> "
                    fi
                  done
                fi
              fi


          # ================================================================
          # ğŸ‘¥ ë¦¬ë·°ì–´ í• ë‹¹ ë¡œì§ (í•„ìš”í•œ ê²½ìš°ì—ë§Œ)
          # ================================================================

          if [ "$NEEDS_REVIEWER_ASSIGNMENT" = true ]; then
            echo "ğŸ‘¤ ë¦¬ë·°ì–´ í›„ë³´ë¥¼ ì°¾ëŠ” ì¤‘... (ì‘ì„±ì: $PR_AUTHOR ì œì™¸)"
            CANDIDATES=$(jq -r --arg author "$PR_AUTHOR" '.members[] | select(.github_id != $author) | .github_id' .github/config/team_members.json)
            CANDIDATE_COUNT=$(echo "$CANDIDATES" | grep -v '^$' | wc -l)
            echo "ì„ íƒ ê°€ëŠ¥í•œ ë¦¬ë·°ì–´ í›„ë³´: $CANDIDATE_COUNT ëª…"

            if [ "$CANDIDATE_COUNT" -gt 0 ]; then
              # ë¦¬ë·°ì–´ ìˆ˜ ê²°ì •
              if [ "$CANDIDATE_COUNT" -ge 2 ]; then
                NUM_TO_SELECT=2
              else
                NUM_TO_SELECT=1
              fi

              echo "ì„ íƒí•  ë¦¬ë·°ì–´ ìˆ˜: $NUM_TO_SELECT ëª…"
              REVIEWER_IDS=$(echo "$CANDIDATES" | shuf -n "$NUM_TO_SELECT" | tr '\n' ',' | sed 's/,$//')

              # GitHubì— ë¦¬ë·°ì–´ í• ë‹¹
              echo "ğŸ¤ ì„ íƒëœ ë¦¬ë·°ì–´ ($REVIEWER_IDS)ë¥¼ PRì— í• ë‹¹í•©ë‹ˆë‹¤."
              gh pr edit $PR_NUMBER --add-reviewer "$REVIEWER_IDS"
              gh pr edit $PR_NUMBER --add-label "review-requested"

              # ìŠ¬ë™ ë©˜ì…˜ ì¤€ë¹„
              IFS=',' read -r -a id_array <<< "$REVIEWER_IDS"
              for id in "${id_array[@]}"; do
                if [ -n "$id" ]; then
                  slack_id=$(get_review_member_info "$TEAM_MEMBERS" "$id" "slack_id")
                  REVIEWER_MENTIONS+="<@$slack_id> "
                fi
              done
            else
              echo "âš ï¸ ë¦¬ë·°ì–´ë¥¼ ì„ íƒí•  ìˆ˜ ì—†ê±°ë‚˜ í›„ë³´ê°€ ì—†ìŠµë‹ˆë‹¤."
              REVIEWER_MENTIONS="ë¦¬ë·°ì–´ ìë™ í• ë‹¹ ì‹¤íŒ¨"
            fi
          fi

          # ================================================================
          # ğŸ“¤ í†µí•© Slack ì•Œë¦¼ ì „ì†¡
          # ================================================================

          # ìµœì¢… ë©”ì‹œì§€ êµ¬ì„±
          FINAL_SLACK_MESSAGE="<$PR_URL|$PR_TITLE> - $SLACK_ICON
          *ì‘ì„±ì:* $AUTHOR_MENTION"

          if [ -n "$REVIEWER_MENTIONS" ] && [ "$REVIEWER_MENTIONS" != "ë¦¬ë·°ì–´ ìë™ í• ë‹¹ ì‹¤íŒ¨" ]; then
            FINAL_SLACK_MESSAGE="$FINAL_SLACK_MESSAGE
            *ë¦¬ë·°ì–´:* $(echo $REVIEWER_MENTIONS | xargs) :crown:"
          elif [ "$REVIEWER_MENTIONS" = "ë¦¬ë·°ì–´ ìë™ í• ë‹¹ ì‹¤íŒ¨" ]; then
            FINAL_SLACK_MESSAGE="$FINAL_SLACK_MESSAGE
            *ë¦¬ë·°ì–´:* $REVIEWER_MENTIONS"
          fi

          FINAL_SLACK_MESSAGE="$FINAL_SLACK_MESSAGE
          *ìƒíƒœ:* $SLACK_MESSAGE
          *ì½”ë“œ ë³€ê²½:* \`+${ADDITIONS} / -${DELETIONS}\`${FILES_INFO}"

          # ì¶”ê°€ ì •ë³´ê°€ ìˆëŠ” ê²½ìš° (ì‹¤íŒ¨ ì‹œ GitHub Action URL ë“±)
          if echo "$SLACK_MESSAGE" | grep -q "Github Action:"; then
            GITHUB_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            FINAL_SLACK_MESSAGE="$FINAL_SLACK_MESSAGE
            *Github Action:* $GITHUB_URL"
          fi

          echo "ğŸ“¤ Slack ì•Œë¦¼ ì „ì†¡ ì¤‘..."
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\": \"$FINAL_SLACK_MESSAGE\", \"username\": \"GitHub PR Notifier\"}" \
            "$SLACK_WEBHOOK_URL"

          echo "=== ğŸ ì›Œí¬í”Œë¡œìš° ì¢…ë£Œ ==="