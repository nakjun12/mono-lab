name: Test Stateful Reviewer Workflow

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [main]

jobs:
  test_job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

  # ì„±ê³µ/ì‹¤íŒ¨ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ì•„ë˜ ë‘ ì¡ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ì—¬ ì‚¬ìš©í•˜ì„¸ìš”.
  success_job:
    name: This job will succeed
    runs-on: ubuntu-latest
    steps:
      - name: ì„±ê³µí•˜ëŠ” ë‹¨ê³„
        run: echo "This job always succeeds."

  failure_job:
    name: This job will fail
    runs-on: ubuntu-latest
    steps:
      - name: ì‹¤íŒ¨í•˜ëŠ” ë‹¨ê³„
        run: |
          echo "This job is designed to fail."
          exit 1

  notify-on-completion:
    name: Notify Slack on Job Completion
    # success_jobê³¼ failure_job ë‘˜ ì¤‘ í•˜ë‚˜ë§Œ needsì— í¬í•¨í•˜ì—¬ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”.
    needs: [test_job, success_job] # ì‹¤íŒ¨ë¥¼ í…ŒìŠ¤íŠ¸í•˜ë ¤ë©´ success_jobì„ failure_jobìœ¼ë¡œ ë°”ê¾¸ì„¸ìš”.
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Run Stateful Notification Logic
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # gh cli ì‚¬ìš©ì„ ìœ„í•´ ì¶”ê°€
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          NEEDS_JSON: ${{ toJson(needs) }}
          # ë¼ë²¨ í™•ì¸ ë° PR ìˆ˜ì •ì„ ìœ„í•´ ì•„ë˜ ë³€ìˆ˜ë“¤ì„ ì¶”ê°€
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          PR_LABELS: ${{ toJSON(github.event.pull_request.labels.*.name) }}
        run: |
          # ================================================================
          # ğŸ“ ì‚¬ì „ ì¤€ë¹„ ë° ë””ë²„ê¹… ë¡œê·¸ (ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸)
          # ================================================================
          echo "=== ğŸš¦ ì›Œí¬í”Œë¡œìš° ì‹œì‘: ìƒíƒœ í™•ì¸ ë° ì•Œë¦¼ ì²˜ë¦¬ ==="
          source .github/script/team_review_helpers.sh
          TEAM_MEMBERS=$(cat .github/config/team_members.json)

          PR_URL="${{ github.event.pull_request.html_url }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          ADDITIONS="${{ github.event.pull_request.additions }}"
          DELETIONS="${{ github.event.pull_request.deletions }}"

          if ! check_author "$TEAM_MEMBERS" "$PR_AUTHOR"; then
              echo "ì‘ì„±ìê°€ íŒ€ ë©¤ë²„ê°€ ì•„ë‹ˆë¯€ë¡œ ì•Œë¦¼ì„ ê±´ë„ˆëœë‹ˆë‹¤."
              exit 0
          fi

          AUTHOR_NAME=$(get_review_member_info "$TEAM_MEMBERS" "$PR_AUTHOR" "name")
          AUTHOR_MENTION="<@$(get_review_member_info "$TEAM_MEMBERS" "$PR_AUTHOR" "slack_id")>"

          # ìµœì¢… ìƒíƒœ ê²°ì •
          OVERALL_STATUS="success"
          if echo "$NEEDS_JSON" | jq -e '.[] | select(.result == "failure" or .result == "cancelled")' > /dev/null; then
            OVERALL_STATUS="failure"
          fi
          echo "âœ… ìµœì¢… ì‘ì—… ìƒíƒœ: $OVERALL_STATUS"

          # ================================================================
          #  logique 1: ë¹Œë“œ ì‹¤íŒ¨ ì‹œ ì²˜ë¦¬
          # ================================================================
          if [ "$OVERALL_STATUS" = "failure" ]; then
            echo "ğŸš« ë¹Œë“œ ì‹¤íŒ¨! ì‹¤íŒ¨ ì•Œë¦¼ì„ ì¤€ë¹„í•˜ê³  ë¦¬ë·°ì–´ í• ë‹¹ì€ ê±´ë„ˆëœë‹ˆë‹¤."

            echo "ğŸ·ï¸ 'build-failed' ë¼ë²¨ì„ PRì— ì¶”ê°€í•©ë‹ˆë‹¤..."
            gh pr edit $PR_NUMBER --add-label "build-failed"

            GITHUB_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            MESSAGE="<$PR_URL|$PR_TITLE> - :x:
            *ì‘ì„±ì:* $AUTHOR_MENTION
            *ì½”ë“œ ë³€ê²½:* \`+${ADDITIONS} / -${DELETIONS}\`
            *Github Action:* $GITHUB_URL"

            echo "ğŸ“¤ ì‹¤íŒ¨ ì•Œë¦¼(MESSAGE1)ë§Œ ì „ì†¡í•©ë‹ˆë‹¤..."
            curl -X POST -H 'Content-type: application/json' --data "{\"text\": \"$MESSAGE\", \"username\": \"GitHub PR Status\"}" "$SLACK_WEBHOOK_URL"

            echo "=== ğŸ ì›Œí¬í”Œë¡œìš° ì¢…ë£Œ ==="
            exit 0
          fi

          # ================================================================
          # logique 2: ë¹Œë“œ ì„±ê³µ ì‹œ ì²˜ë¦¬ (ìƒíƒœ ê¸°ì–µ)
          # ================================================================
          echo "âœ… ë¹Œë“œ ì„±ê³µ! ìƒíƒœ ë¼ë²¨ì„ í™•ì¸í•˜ì—¬ ë¦¬ë·°ì–´ í• ë‹¹ ì—¬ë¶€ë¥¼ ê²°ì •í•©ë‹ˆë‹¤."

          # ì´ì „ì— ì‹¤íŒ¨í–ˆë‹¤ë©´ 'build-failed' ë¼ë²¨ ì œê±°
          if echo "$PR_LABELS" | jq -e 'any(. == "build-failed")'; then
            echo "ğŸ·ï¸ ì´ì „ì— ì‹¤íŒ¨í–ˆë˜ 'build-failed' ë¼ë²¨ì„ ì œê±°í•©ë‹ˆë‹¤."
            gh pr edit $PR_NUMBER --remove-label "build-failed"
          fi

          # [í•µì‹¬] ì´ë¯¸ ë¦¬ë·° ìš”ì²­ì„ ë³´ëƒˆëŠ”ì§€ í™•ì¸
          if echo "$PR_LABELS" | jq -e 'any(. == "review-requested")'; then
            echo "â„¹ï¸ 'review-requested' ë¼ë²¨ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤. ì¶”ê°€ ì‘ì—…ì„ ìˆ˜í–‰í•˜ì§€ ì•Šê³  ì¢…ë£Œí•©ë‹ˆë‹¤."
            echo "=== ğŸ ì›Œí¬í”Œë¡œìš° ì¢…ë£Œ ==="
            exit 0
          fi
          # --- ì—¬ê¸°ê°€ 'ìµœì´ˆ ì„±ê³µ' ì‹œì  ---
          echo "âœ¨ ìµœì´ˆ ì„±ê³µ! ë¦¬ë·°ì–´ë¥¼ í• ë‹¹í•˜ê³  í†µí•© ì•Œë¦¼ì„ ë³´ëƒ…ë‹ˆë‹¤."

          # [ìˆ˜ì •] ë¦¬ë·°ì–´ ì„ íƒ ë¡œì§ ë‹¨ìˆœí™”
          echo "ğŸ‘¤ ë¦¬ë·°ì–´ í›„ë³´ë¥¼ ì°¾ëŠ” ì¤‘... (ì‘ì„±ì: $PR_AUTHOR ì œì™¸)"
          # 1. PR ì‘ì„±ìë§Œ ì œì™¸í•˜ê³  ëª¨ë“  í›„ë³´ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
          CANDIDATES=$(jq -r --arg author "$PR_AUTHOR" '.members[] | select(.github_id != $author) | .github_id' .github/config/team_members.json)
          CANDIDATE_COUNT=$(echo "$CANDIDATES" | grep -v '^$' | wc -l)
          echo "ì„ íƒ ê°€ëŠ¥í•œ ë¦¬ë·°ì–´ í›„ë³´: $CANDIDATE_COUNT ëª…"

          REVIEWER_IDS=""
          if [ "$CANDIDATE_COUNT" -gt 0 ]; then
            # 2. í›„ë³´ê°€ 2ëª… ì´ìƒì´ë©´ 2ëª…ì„, 1ëª…ì´ë©´ 1ëª…ì„ ì„ íƒí•©ë‹ˆë‹¤.
            if [ "$CANDIDATE_COUNT" -ge 2 ]; then
              NUM_TO_SELECT=2
            else
              NUM_TO_SELECT=1
            fi

            echo "ì„ íƒí•  ë¦¬ë·°ì–´ ìˆ˜: $NUM_TO_SELECT ëª…"
            REVIEWER_IDS=$(echo "$CANDIDATES" | shuf -n "$NUM_TO_SELECT" | tr '\n' ',')
          fi

          if [ -z "$REVIEWER_IDS" ]; then
             echo "âš ï¸ ë¦¬ë·°ì–´ë¥¼ ì„ íƒí•  ìˆ˜ ì—†ê±°ë‚˜ í›„ë³´ê°€ ì—†ìŠµë‹ˆë‹¤."
             REVIEWER_MENTIONS="ë¦¬ë·°ì–´ ìë™ í• ë‹¹ ì‹¤íŒ¨"
          else
            echo "ğŸ¤ ì„ íƒëœ ë¦¬ë·°ì–´ ($REVIEWER_IDS)ë¥¼ PRì— í• ë‹¹í•©ë‹ˆë‹¤."
            gh pr edit $PR_NUMBER --add-reviewer "$REVIEWER_IDS"
            echo "ğŸ·ï¸ 'review-requested' ë¼ë²¨ì„ PRì— ì¶”ê°€í•©ë‹ˆë‹¤."
            gh pr edit $PR_NUMBER --add-label "review-requested"

            REVIEWER_MENTIONS=""
            IFS=',' read -r -a id_array <<< "$REVIEWER_IDS"
            for id in "${id_array[@]}"; do
              if [ -n "$id" ]; then
                slack_id=$(get_review_member_info "$TEAM_MEMBERS" "$id" "slack_id")
                REVIEWER_MENTIONS+="<@$slack_id> "
              fi
            done
          fi

          # 4. ë©”ì‹œì§€ êµ¬ì„±
          CHANGED_FILES_LIST=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} 2>/dev/null || echo "")
          TOTAL_FILES_COUNT=$(echo "$CHANGED_FILES_LIST" | grep -v '^$' | wc -l)
          CHANGED_FILES_FORMATTED=$(echo "$CHANGED_FILES_LIST" | head -n 10 | sed 's#^#â€¢ #' | grep -v '^â€¢ $')
          if [ "$TOTAL_FILES_COUNT" -gt 10 ]; then
            REMAINING_FILES_COUNT=$((TOTAL_FILES_COUNT - 10))
            CHANGED_FILES_FORMATTED="${CHANGED_FILES_FORMATTED}\n... (ê·¸ ì™¸ ${REMAINING_FILES_COUNT}ê°œ íŒŒì¼)"
          fi

          MESSAGE1="<$PR_URL|$PR_TITLE> - :white_check_mark:
          *ì‘ì„±ì:* $AUTHOR_MENTION
          *ì½”ë“œ ë³€ê²½:* \`+${ADDITIONS} / -${DELETIONS}\`"
          if [ "$TOTAL_FILES_COUNT" -gt 0 ] && [ ! -z "$CHANGED_FILES_FORMATTED" ]; then
            MESSAGE1="$MESSAGE1\n*ë³€ê²½ëœ íŒŒì¼ (${TOTAL_FILES_COUNT}ê°œ):*\n$CHANGED_FILES_FORMATTED"
          fi

          MESSAGE2="<$PR_URL|$PR_TITLE> :crown-sw:
          *ì‘ì„±ì:* ${AUTHOR_NAME}ìŒ¤
          *ë¦¬ë·°ì–´:* $(echo $REVIEWER_MENTIONS | xargs)"

          # 5. ë‘ ë©”ì‹œì§€ ëª¨ë‘ ì „ì†¡
          echo "ğŸ“¤ ì„±ê³µ ì•Œë¦¼(MESSAGE1)ê³¼ ë¦¬ë·°ì–´ ì•Œë¦¼(MESSAGE2)ì„ ëª¨ë‘ ì „ì†¡í•©ë‹ˆë‹¤..."
          curl -X POST -H 'Content-type: application/json' --data "{\"text\": \"$MESSAGE1\", \"username\": \"GitHub PR Status\"}" "$SLACK_WEBHOOK_URL"
          curl -X POST -H 'Content-type: application/json' --data "{\"text\": \"$MESSAGE2\", \"username\": \"GitHub PR Reviewers\"}" "$SLACK_WEBHOOK_URL"

          echo "=== ğŸ ì›Œí¬í”Œë¡œìš° ì¢…ë£Œ ==="