name: Notify on PR Activity
run-name: 'Review on PR #${{ github.event.pull_request.number }} by @${{ github.actor }}'
# ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±°: PR ë¦¬ë·°ê°€ ì œì¶œë˜ê±°ë‚˜, PRì— ì½”ë©˜íŠ¸ê°€ ì‘ì„±ë˜ì—ˆì„ ë•Œ ì‹¤í–‰
on:
  pull_request_review:
    types: [submitted]
  issue_comment:
    types: [created]
  pull_request_review_comment:  # ì¶”ê°€: PR ì½”ë©˜íŠ¸ ë‹µê¸€ ê°ì§€
    types: [created]

jobs:
  # ê¸°ì¡´ ê¸°ëŠ¥: PR ë¦¬ë·° ìƒíƒœ ì•Œë¦¼ (ìŠ¹ì¸, ë³€ê²½ ìš”ì²­)
  notify_on_review:
    name: Notify Slack on Review
    # 'main' ë¸Œëœì¹˜ë¡œ í–¥í•˜ëŠ” PRì˜ ë¦¬ë·°ì¼ ê²½ìš°ì—ë§Œ ì´ ì¡ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
    if: github.event_name == 'pull_request_review' && github.event.pull_request.base.ref == 'main'
    runs-on: ubuntu-latest
    steps:
      - name: Check out Code
        uses: actions/checkout@v4

      - name: Notify Slack on Review Status
        # 'approved' ë˜ëŠ” 'changes_requested' ìƒíƒœì¼ ë•Œë§Œ ì‹¤í–‰í•©ë‹ˆë‹¤.
        if: github.event.review.state == 'approved' || github.event.review.state == 'changes_requested'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          echo "=== PR ë¦¬ë·° ì•Œë¦¼ ì‹œì‘ ==="
          echo "ë¦¬ë·° ìƒíƒœ: ${{ github.event.review.state }}"

          # í—¬í¼ ìŠ¤í¬ë¦½íŠ¸ ë° ì„¤ì • íŒŒì¼ í™•ì¸
          if [ ! -f ".github/script/team_review_helpers.sh" ] || [ ! -f ".github/config/team_members.json" ]; then
            echo "ì˜¤ë¥˜: í—¬í¼ ìŠ¤í¬ë¦½íŠ¸ ë˜ëŠ” íŒ€ì› ì„¤ì • íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi

          source .github/script/team_review_helpers.sh
          REVIEW_MEMBERS=$(cat .github/config/team_members.json)

          PR_URL="${{ github.event.pull_request.html_url }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_AUTHOR_LOGIN="${{ github.event.pull_request.user.login }}"
          REVIEWER_LOGIN="${{ github.event.review.user.login }}"
          REVIEW_STATE="${{ github.event.review.state }}"
          REVIEW_URL="${{ github.event.review.html_url }}"

          PR_AUTHOR_SLACK_ID=$(get_review_member_info "$REVIEW_MEMBERS" "$PR_AUTHOR_LOGIN" "slack_id")
          REVIEWER_SLACK_ID=$(get_review_member_info "$REVIEW_MEMBERS" "$REVIEWER_LOGIN" "slack_id")

          PR_AUTHOR_MENTION=$([ -z "$PR_AUTHOR_SLACK_ID" ] && echo "$PR_AUTHOR_LOGIN" || echo "<@$PR_AUTHOR_SLACK_ID>")
          REVIEWER_MENTION=$([ -z "$REVIEWER_SLACK_ID" ] && echo "$REVIEWER_LOGIN" || echo "<@$REVIEWER_SLACK_ID>")

          if [ "$REVIEW_STATE" = "approved" ]; then
            EMOJI=":tada:"
            STATUS_TEXT="ìŠ¹ì¸"
          elif [ "$REVIEW_STATE" = "changes_requested" ]; then
            EMOJI=":warning:"
            STATUS_TEXT="ë³€ê²½ ìš”ì²­"
          fi

          MESSAGE="*PR:* <$PR_URL|$PR_TITLE> - *$STATUS_TEXT* ${EMOJI}\n*ì‘ì„±ì:* $PR_AUTHOR_MENTION\n*ë¦¬ë·°ì–´:* $REVIEWER_MENTION\n*ë¦¬ë·°:* <$REVIEW_URL|ë¦¬ë·° ë°”ë¡œê°€ê¸°>"

          echo "=== ì „ì†¡í•  ë©”ì‹œì§€ ë¯¸ë¦¬ë³´ê¸° ==="
          echo -e "$MESSAGE"
          echo "=========================="

          # Slackì— ë©”ì‹œì§€ ì „ì†¡
          curl -X POST -H 'Content-type: application/json' --data "{\"text\": \"$MESSAGE\"}" "$SLACK_WEBHOOK_URL"
          echo "âœ… Slack ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ"

  notify_on_mention:
    name: Notify Slack on Mention
    # ì´ìŠˆ ì½”ë©˜íŠ¸ ë˜ëŠ” PR ë¦¬ë·° ì½”ë©˜íŠ¸ì—ì„œ ë©˜ì…˜ì´ ìˆì„ ë•Œ ì‹¤í–‰
    if: |
      (github.event_name == 'issue_comment' && github.event.issue.pull_request) ||
      github.event_name == 'pull_request_review_comment'
    runs-on: ubuntu-latest
    steps:
      - name: Check out Code
        uses: actions/checkout@v4

      - name: Notify Slack on Mention
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # 'gh' CLI ì¸ì¦ì— í•„ìš”
        run: |
          echo "=== PR ë©˜ì…˜ ì•Œë¦¼ ì‹œì‘ ==="

          # ğŸ” GitHub ì´ë²¤íŠ¸ ì •ë³´ ë””ë²„ê¹…
          echo "ğŸ” [DEBUG] GitHub ì´ë²¤íŠ¸ ì •ë³´:"
          echo "  - Event Name: ${{ github.event_name }}"
          echo "  - Repository: ${{ github.repository }}"
          echo "  - Actor: ${{ github.actor }}"
          echo "  - Ref: ${{ github.ref }}"

          # ì´ë²¤íŠ¸ íƒ€ì…ì— ë”°ë¥¸ ë³€ìˆ˜ ì„¤ì • ë° ë””ë²„ê¹…
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            # ì¼ë°˜ PR ì½”ë©˜íŠ¸
            COMMENT_BODY="${{ github.event.comment.body }}"
            COMMENTER_LOGIN="${{ github.event.comment.user.login }}"
            PR_URL="${{ github.event.issue.html_url }}"
            PR_TITLE="${{ github.event.issue.title }}"
            COMMENT_URL="${{ github.event.comment.html_url }}"
            PR_NUMBER="${{ github.event.issue.number }}"

            echo "ğŸ” [DEBUG] ì´ìŠˆ ì½”ë©˜íŠ¸ ì´ë²¤íŠ¸ ê°ì§€"
            echo "  - Comment ID: ${{ github.event.comment.id }}"
            echo "  - Issue Number: ${{ github.event.issue.number }}"
            echo "  - Is Pull Request: ${{ github.event.issue.pull_request != null }}"

          elif [ "${{ github.event_name }}" = "pull_request_review_comment" ]; then
            # PR ë¦¬ë·° ì½”ë©˜íŠ¸ (ë‹µê¸€)
            COMMENT_BODY="${{ github.event.comment.body }}"
            COMMENTER_LOGIN="${{ github.event.comment.user.login }}"
            PR_URL="${{ github.event.pull_request.html_url }}"
            PR_TITLE="${{ github.event.pull_request.title }}"
            COMMENT_URL="${{ github.event.comment.html_url }}"
            PR_NUMBER="${{ github.event.pull_request.number }}"

            echo "ğŸ” [DEBUG] PR ë¦¬ë·° ì½”ë©˜íŠ¸ ì´ë²¤íŠ¸ ê°ì§€"
            echo "  - Comment ID: ${{ github.event.comment.id }}"
            echo "  - PR Number: ${{ github.event.pull_request.number }}"
            echo "  - Review ID: ${{ github.event.review.id }}"
          fi

          # ğŸ” ì¶”ì¶œëœ ë³€ìˆ˜ë“¤ í™•ì¸
          echo "ğŸ” [DEBUG] ì¶”ì¶œëœ ë³€ìˆ˜ ê°’ë“¤:"
          echo "  - COMMENTER_LOGIN: '$COMMENTER_LOGIN'"
          echo "  - PR_NUMBER: '$PR_NUMBER'"
          echo "  - PR_TITLE: '$PR_TITLE'"
          echo "  - PR_URL: '$PR_URL'"
          echo "  - COMMENT_URL: '$COMMENT_URL'"
          echo "  - COMMENT_BODY ê¸¸ì´: ${#COMMENT_BODY} characters"
          echo "  - COMMENT_BODY ë¯¸ë¦¬ë³´ê¸° (ì²« 100ì): '${COMMENT_BODY:0:100}'"

          # gh clië¥¼ ì‚¬ìš©í•´ PRì˜ ë² ì´ìŠ¤ ë¸Œëœì¹˜ í™•ì¸
          echo "ğŸ” [DEBUG] gh CLIë¡œ PR ì •ë³´ ì¡°íšŒ ì¤‘..."
          BASE_BRANCH=$(gh pr view $PR_NUMBER --json baseRefName --jq .baseRefName)
          echo "  - BASE_BRANCH: '$BASE_BRANCH'"

          if [ "$BASE_BRANCH" != "main" ]; then
            echo "âŒ PRì´ main ë¸Œëœì¹˜ë¥¼ ëŒ€ìƒìœ¼ë¡œ í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì•Œë¦¼ì„ ë³´ë‚´ì§€ ì•ŠìŠµë‹ˆë‹¤. (ëŒ€ìƒ: $BASE_BRANCH)"
            exit 0
          fi

          # í—¬í¼ ìŠ¤í¬ë¦½íŠ¸ ë° ì„¤ì • íŒŒì¼ í™•ì¸
          echo "ğŸ” [DEBUG] í•„ìˆ˜ íŒŒì¼ ì¡´ì¬ í™•ì¸:"
          echo "  - .github/script/team_review_helpers.sh: $([ -f ".github/script/team_review_helpers.sh" ] && echo "ì¡´ì¬" || echo "ì—†ìŒ")"
          echo "  - .github/config/team_members.json: $([ -f ".github/config/team_members.json" ] && echo "ì¡´ì¬" || echo "ì—†ìŒ")"

          if [ ! -f ".github/script/team_review_helpers.sh" ] || [ ! -f ".github/config/team_members.json" ]; then
            echo "âŒ ì˜¤ë¥˜: í—¬í¼ ìŠ¤í¬ë¦½íŠ¸ ë˜ëŠ” íŒ€ì› ì„¤ì • íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi

          source .github/script/team_review_helpers.sh
          REVIEW_MEMBERS=$(cat .github/config/team_members.json)

          # ğŸ” íŒ€ ë©¤ë²„ ë°ì´í„° í™•ì¸
          echo "ğŸ” [DEBUG] íŒ€ ë©¤ë²„ ë°ì´í„°:"
          echo "  - JSON íŒŒì¼ í¬ê¸°: $(echo "$REVIEW_MEMBERS" | wc -c) bytes"
          echo "  - JSON ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°: $(echo "$REVIEW_MEMBERS" | head -c 200)..."

          COMMENTER_SLACK_ID=$(get_review_member_info "$REVIEW_MEMBERS" "$COMMENTER_LOGIN" "slack_id")
          COMMENTER_MENTION=$([ -z "$COMMENTER_SLACK_ID" ] && echo "$COMMENTER_LOGIN" || echo "<@$COMMENTER_SLACK_ID>")

          echo "ğŸ” [DEBUG] ì‘ì„±ì ì •ë³´:"
          echo "  - COMMENTER_SLACK_ID: '$COMMENTER_SLACK_ID'"
          echo "  - COMMENTER_MENTION: '$COMMENTER_MENTION'"

          # ğŸ” ë©˜ì…˜ ì¶”ì¶œ ë¡œì§ ë””ë²„ê¹…
          echo "ğŸ” [DEBUG] ë©˜ì…˜ ì¶”ì¶œ ê³¼ì •:"
          echo "  - grep ì‹¤í–‰ ì „ COMMENT_BODY: '$COMMENT_BODY'"

          # ë©˜ì…˜ ì¶”ì¶œ ë‹¨ê³„ë³„ í™•ì¸
          GREP_OUTPUT=$(echo "$COMMENT_BODY" | grep -oP '@[a-zA-Z0-9_-]+' || echo "")
          echo "  - grep ê²°ê³¼: '$GREP_OUTPUT'"

          SED_OUTPUT=$(echo "$GREP_OUTPUT" | sed 's/@//')
          echo "  - sed ê²°ê³¼: '$SED_OUTPUT'"

          MENTIONED_USERS=$(echo "$SED_OUTPUT" | sort -u)
          echo "  - ìµœì¢… MENTIONED_USERS: '$MENTIONED_USERS'"
          echo "  - ë©˜ì…˜ëœ ì‚¬ìš©ì ìˆ˜: $(echo "$MENTIONED_USERS" | wc -w)"

          if [ -z "$MENTIONED_USERS" ]; then
            echo "âŒ ì½”ë©˜íŠ¸ì— ë©˜ì…˜ëœ ì‚¬ìš©ìê°€ ì—†ì–´ ì•Œë¦¼ì„ ë³´ë‚´ì§€ ì•ŠìŠµë‹ˆë‹¤."
            exit 0
          fi

          # ë©˜ì…˜ëœ ê° ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼ ì „ì†¡ (ë©˜ì…˜ ì‘ì„±ì ë³¸ì¸ë„ í¬í•¨)
          USER_COUNT=0
          for USER in $MENTIONED_USERS; do
            USER_COUNT=$((USER_COUNT + 1))
            echo ""
            echo "ğŸ” [DEBUG] ì‚¬ìš©ì #${USER_COUNT} ì²˜ë¦¬ ì¤‘:"
            echo "  - USER: '$USER'"

            MENTIONED_SLACK_ID=$(get_review_member_info "$REVIEW_MEMBERS" "$USER" "slack_id")
            echo "  - MENTIONED_SLACK_ID: '$MENTIONED_SLACK_ID'"

            if [ -z "$MENTIONED_SLACK_ID" ] || [ "$MENTIONED_SLACK_ID" = "null" ]; then
              echo "âŒ ê²½ê³ : '$USER'ì˜ Slack IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ ì•Œë¦¼ì„ ê±´ë„ˆëœë‹ˆë‹¤."
              continue
            fi

            MENTIONED_USER_TAG="<@${MENTIONED_SLACK_ID}>"
            echo "  - MENTIONED_USER_TAG: '$MENTIONED_USER_TAG'"

            # --- âœ¨ ê°œì„ ëœ ë©”ì‹œì§€ ìƒì„± ë¡œì§ ---

            # 1. ì½”ë©˜íŠ¸ ë‚´ìš©ì„ Slackì—ì„œ ì½ê¸° ì‰½ê²Œ í¬ë§·íŒ…
            # ê¸´ ì½”ë©˜íŠ¸ì˜ ê²½ìš° ì²« 200ìë§Œ ë³´ì—¬ì£¼ê³  "..." ì¶”ê°€
            COMMENT_PREVIEW=$(echo "$COMMENT_BODY" | head -c 200)
            if [ ${#COMMENT_BODY} -gt 200 ]; then
              COMMENT_PREVIEW="${COMMENT_PREVIEW}..."
            fi

            echo "ğŸ” [DEBUG] ë©”ì‹œì§€ í¬ë§·íŒ…:"
            echo "  - ì›ë³¸ ê¸¸ì´: ${#COMMENT_BODY}"
            echo "  - ë¯¸ë¦¬ë³´ê¸° ê¸¸ì´: ${#COMMENT_PREVIEW}"
            echo "  - COMMENT_PREVIEW: '$COMMENT_PREVIEW'"

            # 2. ê°œí–‰ ë¬¸ìë¥¼ ì²˜ë¦¬í•˜ê³  ì¸ìš© ë¸”ë¡ìœ¼ë¡œ í‘œì‹œ
            FORMATTED_COMMENT=$(echo "$COMMENT_PREVIEW" | sed 's/^/> /')
            echo "  - FORMATTED_COMMENT: '$FORMATTED_COMMENT'"

            # 3. ë©”ì‹œì§€ í…œí”Œë¦¿ ìƒì„±
            MESSAGE_TEMPLATE="${MENTIONED_USER_TAG}ë‹˜, ${COMMENTER_MENTION}ë‹˜ì´ PRì—ì„œ íšŒì›ë‹˜ì„ ë©˜ì…˜í–ˆìŠµë‹ˆë‹¤. :speech_balloon:\n\n*PR:* <${PR_URL}|${PR_TITLE}>\n\n*ì½”ë©˜íŠ¸ ë‚´ìš©:*\n${FORMATTED_COMMENT}\n\n<${COMMENT_URL}|ì½”ë©˜íŠ¸ ë°”ë¡œê°€ê¸°>"

            echo "ğŸ” [DEBUG] ë©”ì‹œì§€ í…œí”Œë¦¿:"
            echo "  - MESSAGE_TEMPLATE: '$MESSAGE_TEMPLATE'"

            # 4. jqë¥¼ ì‚¬ìš©í•˜ì—¬ JSON í˜ì´ë¡œë“œ ì•ˆì „í•˜ê²Œ ìƒì„±
            PAYLOAD=$(jq -n --arg text "$MESSAGE_TEMPLATE" '{"text": $text}')
            echo "ğŸ” [DEBUG] JSON í˜ì´ë¡œë“œ:"
            echo "  - PAYLOAD ê¸¸ì´: ${#PAYLOAD} bytes"
            echo "  - PAYLOAD ë¯¸ë¦¬ë³´ê¸°: $(echo "$PAYLOAD" | head -c 300)..."

            echo "=== ì „ì†¡í•  ë©”ì‹œì§€ ë¯¸ë¦¬ë³´ê¸° ($USER) ==="
            echo "$MESSAGE_TEMPLATE"
            echo "==================================="

            # 5. Slack ì›¹í›… URL í™•ì¸
            echo "ğŸ” [DEBUG] Slack ì „ì†¡ ì¤€ë¹„:"
            echo "  - SLACK_WEBHOOK_URL ì„¤ì •ë¨: $([ -n "$SLACK_WEBHOOK_URL" ] && echo "ì˜ˆ" || echo "ì•„ë‹ˆì˜¤")"
            echo "  - SLACK_WEBHOOK_URL ê¸¸ì´: ${#SLACK_WEBHOOK_URL}"

            # 6. ìƒì„±ëœ JSON í˜ì´ë¡œë“œë¥¼ Slack