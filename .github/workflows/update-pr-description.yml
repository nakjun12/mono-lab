name: Update PR Description

on:
  pull_request:
    types: [opened, synchronize, edited]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  update-pr-description:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Get changed files, packages, and commits
        id: changes
        run: |
          # Get changed files
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | sort | uniq)
          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Function to find the nearest package.json or parent directory name
          find_package() {
            local dir=$(dirname "$1")
            while [[ "$dir" != "." && "$dir" != "/" ]]; do
              if [[ -f "$dir/package.json" ]]; then
                echo $(jq -r .name "$dir/package.json")
                return 0
              fi
              dir=$(dirname "$dir")
            done

              if [[ -f "./package.json" ]]; then
                echo $(jq -r .name "./package.json")
                return 0
              fi

            echo "Unknown"
          }

          # Get package names
          CHANGED_PACKAGES=$(echo "$CHANGED_FILES" | while read file; do find_package "$file"; done | sort | uniq)
          if [ -z "$CHANGED_PACKAGES" ]; then
            CHANGED_PACKAGES="No packages detected"
          fi
          echo "Changed packages:"
          echo "$CHANGED_PACKAGES"

          # Get all commit messages
          COMMIT_MESSAGES=$(git log --format="- %s%n%b" ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | sed '/./s/^$//' | sed -e '/^$/d' -e '/^- $/d')
          echo "Commit messages:"
          echo "$COMMIT_MESSAGES"

          # Set outputs
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "changed_packages<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_PACKAGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "commit_messages<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_MESSAGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Fetch Open Issues for PR Creator
        id: open_issues
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ORG: "my-type-world-cup"
          REPO: "my-type-world-cup-frontend"
        run: |
          PR_CREATOR=$(gh pr view ${{ github.event.pull_request.number }} --json author --jq .author.login)
          OPEN_ISSUES=$(gh api graphql -f query='
            query($org: String!, $repo: String!, $creator: String!) {
              repository(owner: $org, name: $repo) {
                issues(states: OPEN, first: 20, filterBy: {assignee: $creator}) {
                  nodes {
                    number
                    title
                    url
                  }
                }
              }
            }
          ' -F org=$ORG -F repo=$REPO -F creator=$PR_CREATOR --jq '.data.repository.issues.nodes[] | "- [ ] \(env.ORG)/\(env.REPO)#\(.number) \(.title)"')

          echo "open_issues<<EOF" >> $GITHUB_OUTPUT
          echo "$OPEN_ISSUES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update PR Description and Link Issues
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          ORG: "my-type-world-cup"
          REPO: "my-type-world-cup-frontend"
        run: |
          # Get the current PR description
          CURRENT_DESCRIPTION=$(gh pr view $PR_NUMBER --json body -q .body)

          # Extract the current issue section
          CURRENT_ISSUE_SECTION=$(echo "$CURRENT_DESCRIPTION" | sed -n '/^### ê´€ë ¨ ì´ìŠˆ/,/^---/p')

          # Prepare the new PR description
          NEW_DESCRIPTION=$'## ğŸ¤– ìë™ ìƒì„±ëœ PR ì •ë³´\n\n'
          NEW_DESCRIPTION+=$'### ğŸ“¦ ë³€ê²½ëœ íŒ¨í‚¤ì§€\n'
          if [ "${{ steps.changes.outputs.changed_packages }}" == "No packages detected" ]; then
            NEW_DESCRIPTION+=$'íŒ¨í‚¤ì§€ ë³€ê²½ ì—†ìŒ\n'
          else
            NEW_DESCRIPTION+=$(echo "${{ steps.changes.outputs.changed_packages }}" | sed 's/^/- /' | sed 's/*/-/g')
          fi

          NEW_DESCRIPTION+=$'\n### ğŸ“„ ë³€ê²½ëœ íŒŒì¼\n'
          NEW_DESCRIPTION+=$(echo "${{ steps.changes.outputs.changed_files }}" | sed 's/^/- /' | sed 's/*/-/g')

          NEW_DESCRIPTION+=$'\n\n### ğŸ“ ì»¤ë°‹ ë‚´ì—­\n'
          NEW_DESCRIPTION+=$(echo "${{ steps.changes.outputs.commit_messages }}" | sed 's/^/- /' | sed 's/^- - /- /')

          NEW_DESCRIPTION+=$'\n\n### ê´€ë ¨ ì´ìŠˆ\n'
          NEW_DESCRIPTION+=$'ì•„ë˜ ëª©ë¡ì—ì„œ ì´ PRê³¼ ê´€ë ¨ëœ ì´ìŠˆë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”. ì„ íƒí•œ ì´ìŠˆëŠ” ìë™ìœ¼ë¡œ PRê³¼ ì—°ê²°ë©ë‹ˆë‹¤:\n\n'

          # Process open issues and preserve checked state
          while IFS='|' read -r issue_number issue_title; do
            if echo "$CURRENT_ISSUE_SECTION" | grep -q "\[x\] $ORG/$REPO#$issue_number"; then
              NEW_DESCRIPTION+="- [x] $ORG/$REPO#$issue_number $issue_title\n"
            else
              NEW_DESCRIPTION+="- [ ] $ORG/$REPO#$issue_number $issue_title\n"
            fi
          done <<< "${{ steps.open_issues.outputs.open_issues }}"

          NEW_DESCRIPTION+=$'\n---\n\n'

          # Extract the manual part of the description (everything after the auto-generated part)
          MANUAL_DESCRIPTION=$(echo "$CURRENT_DESCRIPTION" | sed -n '/^---$/,$p' | tail -n +2)

          # Combine the new auto-generated part with the manual part
          FULL_DESCRIPTION="${NEW_DESCRIPTION}${MANUAL_DESCRIPTION}"

          # Update the PR description
          gh pr edit $PR_NUMBER --body "${FULL_DESCRIPTION}"

          # Extract the updated issue section
          UPDATED_ISSUE_SECTION=$(echo "$FULL_DESCRIPTION" | sed -n '/^### ê´€ë ¨ ì´ìŠˆ/,/^---/p')

          # Find checked issues
          CHECKED_ISSUES=$(echo "$UPDATED_ISSUE_SECTION" | grep -oP "(?<=- \[x\] $ORG/$REPO#)\d+")

          # Unlink previously linked issues
          CURRENT_LINKED_ISSUES=$(gh pr view $PR_NUMBER --json projectItems --jq '.projectItems[].content.number')
          for ISSUE in $CURRENT_LINKED_ISSUES
          do
            gh pr edit $PR_NUMBER --remove-project "Issue #$ISSUE"
            echo "Unlinked issue #$ISSUE from PR #$PR_NUMBER"
          done

          # Link newly checked issues to PR
          for ISSUE in $CHECKED_ISSUES
          do
            gh pr edit $PR_NUMBER --add-project "Issue #$ISSUE"
            echo "Linked issue #$ISSUE to PR #$PR_NUMBER"
          done

          # Update PR description to reflect linked issues
          FINAL_ISSUE_SECTION=$(echo "$UPDATED_ISSUE_SECTION" | sed "s/- \[x\] $ORG\/$REPO#\($CHECKED_ISSUES\)/- [x] $ORG\/$REPO#\1 (ì—°ê²°ë¨)/g")
          FINAL_PR_BODY="${FULL_DESCRIPTION//$UPDATED_ISSUE_SECTION/$FINAL_ISSUE_SECTION}"

          gh pr edit $PR_NUMBER --body "$FINAL_PR_BODY"
