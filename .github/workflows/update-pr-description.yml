name: Update PR Description

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  update-pr-description:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Get changed files, packages, and commits
        id: changes
        run: |
          # Get changed files
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | sort | uniq)
          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Get package names from package.json files
          CHANGED_PACKAGES=$(echo "$CHANGED_FILES" | grep -oP '.*(?=/package\.json)' | xargs -I {} jq -r .name {}/package.json 2>/dev/null | sort | uniq)
          if [ -z "$CHANGED_PACKAGES" ]; then
            CHANGED_PACKAGES="No package.json files were modified"
          fi
          echo "Changed packages:"
          echo "$CHANGED_PACKAGES"

          # Get specific commit message
          COMMIT_MESSAGE=$(git log --format="%s" ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | grep "fix: github action pr 권한 추가" | head -n 1)
          if [ -z "$COMMIT_MESSAGE" ]; then
            COMMIT_MESSAGE="No matching commit message found"
          fi
          echo "Commit message:"
          echo "$COMMIT_MESSAGE"

          # Set outputs
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "changed_packages<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_PACKAGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "commit_message<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_MESSAGE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update PR Description
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          # Prepare the new PR description
          NEW_DESCRIPTION="## 자동 생성된 PR 정보\n\n"
          NEW_DESCRIPTION+="## 변경 사항 요약\n"
          NEW_DESCRIPTION+="### 수정된 패키지:\n"
          NEW_DESCRIPTION+=$(echo "${{ steps.changes.outputs.changed_packages }}" | sed 's/^/- /')
          NEW_DESCRIPTION+="\n\n## 변경 내용\n"
          NEW_DESCRIPTION+="### 변경된 파일:\n"
          NEW_DESCRIPTION+=$(echo "${{ steps.changes.outputs.changed_files }}" | sed 's/^/- /')
          NEW_DESCRIPTION+="\n\n### 커밋 내역:\n"
          NEW_DESCRIPTION+="${{ steps.changes.outputs.commit_message }}"
          NEW_DESCRIPTION+="\n\n---\n\n"

          # Get the current PR description
          CURRENT_DESCRIPTION=$(gh pr view $PR_NUMBER --json body -q .body)

          # Extract the manual part of the description (everything after the auto-generated part)
          MANUAL_DESCRIPTION=$(echo "$CURRENT_DESCRIPTION" | sed -n '/^---$/,$p' | tail -n +2)

          # Combine the new auto-generated part with the manual part
          FULL_DESCRIPTION="${NEW_DESCRIPTION}${MANUAL_DESCRIPTION}"

          # Update the PR description
          gh pr edit $PR_NUMBER --body "${FULL_DESCRIPTION}"
